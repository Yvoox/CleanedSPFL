# CleanedSPFL

## Deployment instructions
SPFL is a composition of three services:
- a static HTML/JS website used to display the application and load the data,
- a node.js server serving the data about flower species and bouquets
- a flask application serving the position of flowers in bouquets

The following instructions explain how to deploy these services on a server running Ubuntu 18.04, using the Nginx webserver.

### Flask application setup
Follow the instructions [here](https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-uswgi-and-nginx-on-ubuntu-18-04) to serve the application using uWSGI.

The configuration files created during the process are shown below.

#### pca.ini
```
[uwsgi]
module = wsgi:app

master = true
processes = 5

socket = myproject.sock
chmod-socket = 660
vacuum = true

die-on-term = true
```

#### /etc/systemd/system/pca.service
```
[Unit]
Description=uWSGI instance to serve Pca (bouquets exploration tool)
After=network.target

[Service]
User=spfl
Group=spfl
WorkingDirectory=/home/spfl/code/api
Environment="PATH=/home/spfl/code/api/myprojectenv/bin"
ExecStart=/home/spfl/code/api/myprojectenv/bin/uwsgi --ini pca.ini

[Install]
WantedBy=multi-user.target
```

### Node.js application setup
The Node.js application needs a startup script (startApiSPFL.sh) and a service that will automatically start the application when the server boots up (/etc/systemd/system/spflNode.service).

#### startApiSPFL.sh:
```
#!/bin/bash

/home/spfl/code/api/node /home/spfl/code/api/apiSPFL.js
```

#### spflNode.service
```
[Unit]
Description=node service for spfl
After=network.target

[Service]
User=spfl
Group=spfl
WorkingDirectory=/home/spfl/code/api
ExecStart=/bin/bash /home/spfl/code/api/startApiSPFL.sh
KillMode=process

[Install]
WantedBy=multi-user.target
```

### Nginx configuration
Nginx is used to serve several routes:
- / opens the website (/home/spfl/code/SPFL)
- /positions is connected to the socket generated by uwsgi (Flask application)
- /species and /bouquets are connected to the Node.js application on port 3000

Here is the configuration file (/etc/nginx/available-sites/spfl):
```
server {
	listen 80;
	server_name spfl.tilaa.cloud;

	root /home/spfl/code/SPFL;

	location /positions {
		include uwsgi_params;
		uwsgi_pass unix:/home/spfl/code/api/myproject.sock;
	}

	location /species {
		proxy_pass http://localhost:3000;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection 'upgrade';
		proxy_set_header Host $host;
		proxy_cache_bypass $http_upgrade;
	}

	location /bouquets {
		proxy_pass http://localhost:3000;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection 'upgrade';
		proxy_set_header Host $host;
		proxy_cache_bypass $http_upgrade;
	}

	location / {
		index index.html;
	}
}
```
